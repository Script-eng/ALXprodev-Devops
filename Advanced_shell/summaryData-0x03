#!/bin/bash

# Define the directory and output file names
data_dir="pokemon_data"
report_file="pokemon_report.csv"

# Check if the data directory exists to prevent errors
if [ ! -d "$data_dir" ]; then
    echo "Error: Directory '$data_dir' not found. Please run the previous script first."
    exit 1
fi

# --- Step 1: Create the CSV file with a header ---
echo "Name,Height (m),Weight (kg)" > "$report_file"

# --- Step 2: Loop through JSON files to extract and format data ---
for file in "$data_dir"/*.json; do
    # Use jq to extract the raw data into shell variables
    name=$(jq -r '.name' "$file")
    height=$(jq -r '.height' "$file")
    weight=$(jq -r '.weight' "$file")

    # Capitalize the first letter of the name using sed
    capitalized_name=$(echo "$name" | sed 's/./\u&/')

    # Use awk to convert units and format the numbers to one decimal place
    formatted_height=$(echo "$height" | awk '{printf "%.1f", $1/10}')
    formatted_weight=$(echo "$weight" | awk '{printf "%.1f", $1/10}')

    # Append the fully formatted row to our report file
    echo "$capitalized_name,$formatted_height,$formatted_weight" >> "$report_file"
done

# --- Step 3: Generate the final output for the user ---

echo "CSV Report generated at: $report_file"
echo "" # Add a newline for spacing

# Display the contents of the generated CSV file
cat "$report_file"
echo "" # Add another newline for spacing

# --- Step 4: Use awk to calculate and print the averages ---

# tail -n +2 skips the header line of the CSV
# awk -F, tells awk to use a comma as the field separator
tail -n +2 "$report_file" | awk -F, '
{
    # For each line, add the height (column 2) and weight (column 3) to our totals
    total_height += $2
    total_weight += $3
}
END {
    # After processing all lines, calculate and print the averages
    # NR is a built-in awk variable for the total number of records (lines) processed
    if (NR > 0) {
        printf "Average Height: %.2f m\n", total_height / NR
        printf "Average Weight: %.2f kg\n", total_weight / NR
    }
}
'